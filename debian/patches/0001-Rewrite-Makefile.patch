From 5c7093b95c0f82e0d3a3fa338a2fe0102ff88f60 Mon Sep 17 00:00:00 2001
From: yangfl <yangfl@users.noreply.github.com>
Date: Sat, 18 Jul 2020 00:46:46 +0800
Subject: [PATCH 1/3] Rewrite Makefile

---
 Makefile        | 74 +++++++++++++++++++++++++++++++++++++++++--------
 simpleini.pc.in | 10 +++++++
 2 files changed, 73 insertions(+), 11 deletions(-)
 create mode 100644 simpleini.pc.in

diff --git a/Makefile b/Makefile
index d69ea94..c593aea 100644
--- a/Makefile
+++ b/Makefile
@@ -1,16 +1,68 @@
-help:
-	@echo This makefile is just for the test program \(use \"make clean all test\"\)
-	@echo Just include the SimpleIni.h header file to use it.
+PROJECT = simpleini
 
-install:
-	@echo No install required. Just include the SimpleIni.h header file to use it.
+MULTIARCH ?= $(shell $(CC) --print-multiarch)
 
-TOPTARGETS := all clean test
+PREFIX ?= /usr
+INCLUDEDIR ?= include
+LIBDIR ?= lib/$(MULTIARCH)
 
-SUBDIRS := tests
+CPPFLAGS += -DSI_CONVERT_ICU -DSI_SUPPORT_IOSTREAMS
 
-$(TOPTARGETS): $(SUBDIRS)
-$(SUBDIRS):
-	$(MAKE) -C $@ $(MAKECMDGOALS)
+HEADERS := $(wildcard *.h)
+SRCS := SimpleIni.cpp
+OBJS := $(SRCS:.cpp=.o)
 
-.PHONY: $(TOPTARGETS) $(SUBDIRS)
+LIB_NAME := lib$(PROJECT).so
+SO_NAME := $(LIB_NAME).1
+REAL_NAME := $(LIB_NAME).$(VERSION)
+
+ARLIB := lib$(PROJECT).a
+SHLIB := $(SO_NAME)
+PCFILE := $(PROJECT).pc
+
+.PHONY: all
+all: $(ARLIB) $(SHLIB) $(PCFILE)
+
+$(ARLIB): $(OBJS)
+	$(AR) rcs $@ $^
+
+$(SHLIB): $(OBJS)
+	$(CXX) -shared -Wl,-soname,$(SO_NAME) -o $@ $^ $(LDFLAGS) -licuuc
+
+SimpleIni.o: SimpleIni.cpp
+	$(CXX) $(CXXFLAGS) $(CPPFLAGS) -fPIC -c -o $@ $^
+
+$(PCFILE): $(PCFILE).in
+	sed 's|@prefix@|$(PREFIX)|; s|@libdir@|$(LIBDIR)|; s|@includedir@|$(INCLUDEDIR)|; s|@version@|$(VERSION)|' $< > $@
+
+.PHONY: clean
+clean:
+	rm -f $(ARLIB) $(SHLIB) $(OBJS) $(PCFILE) *.o testsi test*-out*.ini
+
+.PHONY: install-shared
+install-shared: $(SHLIB)
+	install -d $(DESTDIR)$(PREFIX)/$(LIBDIR) || true
+	install -m 0644 $< $(DESTDIR)$(PREFIX)/$(LIBDIR)/$(REAL_NAME)
+	rm -f $(DESTDIR)$(PREFIX)/$(LIBDIR)/$(SO_NAME)
+	ln -s $(REAL_NAME) $(DESTDIR)$(PREFIX)/$(LIBDIR)/$(SO_NAME)
+	rm -f $(DESTDIR)$(PREFIX)/$(LIBDIR)/$(LIB_NAME)
+	ln -s $(SO_NAME) $(DESTDIR)$(PREFIX)/$(LIBDIR)/$(LIB_NAME)
+
+.PHONY: install-static
+install-static: $(ARLIB)
+	install -d $(DESTDIR)$(PREFIX)/$(LIBDIR) || true
+	install -m 0644 $< $(DESTDIR)$(PREFIX)/$(LIBDIR)/$(ARLIB)
+
+.PHONY: install-header
+install-header: $(HEADERS) $(PCFILE)
+	install -d $(DESTDIR)$(PREFIX)/$(INCLUDEDIR) || true
+	install -m 0644 $(HEADERS) $(DESTDIR)$(PREFIX)/$(INCLUDEDIR)/
+	install -d $(DESTDIR)$(PREFIX)/$(LIBDIR)/pkgconfig || true
+	install -m 0644 $(PCFILE) $(DESTDIR)$(PREFIX)/$(LIBDIR)/pkgconfig
+
+.PHONY: install
+install: install-shared install-static install-header
+
+.PHONY: test
+test:
+	+$(MAKE) -C tests
diff --git a/simpleini.pc.in b/simpleini.pc.in
new file mode 100644
index 0000000..93cbb98
--- /dev/null
+++ b/simpleini.pc.in
@@ -0,0 +1,10 @@
+prefix=@prefix@
+libdir=${prefix}/@libdir@
+includedir=${prefix}/@includedir@
+
+Name: simpleini
+Description: C++ library for INI-style configuration files
+Version: @version@
+Requires: icu-io
+Libs: -L${libdir} -lsimpleini
+Cflags: -I${includedir}
-- 
2.35.1

